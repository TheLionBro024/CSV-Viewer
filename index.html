<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Visor Multi-CSV con Exportación a Excel</title>
<style>
:root {
  --primary-color: #0D3B66;
  --secondary-color: #FAF0CA;
  --bg-color: #0D3B66;
  --text-color: #FAF0CA;
  --font-family: 'Arial', sans-serif;
  --font-size: 14px;
  --border-radius: 6px;
  --spacing: 12px;
  --table-header-bg: var(--primary-color);
  --table-header-text: var(--secondary-color);
  --table-row-hover: #1a1f36;
  --button-bg: var(--primary-color);
  --button-text: var(--secondary-color);
  --button-hover-bg: #081a3f;
  --input-border: #FAF0CA;
  --input-bg: #1a1f36;
  --input-text: var(--secondary-color);
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size);
  color: var(--text-color);
  background-color: var(--bg-color);
  padding: 20px;
}

h2 {
  color: var(--secondary-color);
  margin-bottom: var(--spacing);
}

input[type="file"], input[type="date"], input[type="number"] {
  padding: 6px;
  margin-top: 4px;
  border: 1px solid var(--input-border);
  border-radius: var(--border-radius);
  background-color: var(--input-bg);
  color: var(--input-text);
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: var(--spacing);
  border-radius: var(--border-radius);
  overflow: hidden;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: right;
}

th:first-child, td:first-child {
  text-align: left;
}

th {
  background-color: var(--table-header-bg);
  color: var(--table-header-text);
  font-weight: bold;
}

tr:hover {
  background-color: var(--table-row-hover);
}

.controls {
  display: flex;
  flex-direction: column;
  gap: var(--spacing);
  max-width: 900px;
  margin-top: var(--spacing);
}

.top-row {
  display: flex;
  gap: var(--spacing);
  flex-wrap: wrap;
}

.top-row > div {
  flex: 1;
  min-width: 150px;
}

.checkbox-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 8px;
  border-radius: var(--border-radius);
  background-color: var(--input-bg);
}

button {
  cursor: pointer;
  padding: 6px 12px;
  border: none;
  border-radius: var(--border-radius);
  background-color: var(--button-bg);
  color: var(--button-text);
  font-weight: bold;
  transition: background-color 0.2s;
}

button:hover:not(:disabled) {
  background-color: var(--button-hover-bg);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.paging-controls {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.paging-controls span {
  font-weight: bold;
  color: var(--secondary-color);
}

@media (max-width: 600px) {
  .top-row {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<h2>Visor Multi-CSV</h2>

<input type="file" id="csvFile" accept=".csv" multiple>

<div class="controls">
  <div class="top-row">
    <div>
      <label>Fecha inicio:</label>
      <input type="date" id="startDate">
    </div>
    <div>
      <label>Fecha fin:</label>
      <input type="date" id="endDate">
    </div>
    <div>
      <label>Pileta:</label>
      <input type="number" id="piletaSelector" min="1" step="1" placeholder="Dejar vacío para todas">
    </div>
  </div>

  <div>
    <label>Columnas a mostrar:</label>
    <div id="columnSelector" class="checkbox-list"></div>
  </div>

  <div>
    <label>
      <input type="checkbox" id="sumMode">
      Sumar piletas (Peso esperado y Peso descargado)
    </label>
  </div>

  <div>
    <label>Líneas por página:</label>
    <input type="number" id="rowsPerPage" min="1" value="20">
  </div>

  <button id="applyFilter">Aplicar filtro</button>
  <button id="exportExcel" style="display:none;">Exportar a Excel</button>

  <div class="paging-controls">
    <button id="prevPage" disabled>Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage" disabled>Siguiente</button>
  </div>
</div>

<table id="output"></table>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
let originalRows = [];
let headers = [];
let filteredData = [];
let currentPage = 1;
let totalPages = 1;
const BLOCKED_COLUMNS = ["%SR036","%SR035"];

document.getElementById("csvFile").addEventListener("change", function(e){
  const files = [...e.target.files];
  if(!files.length) return;
  originalRows=[];
  headers=[];
  let filesRead=0;
  const allData=[];
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      const text=ev.target.result;
      const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
      const rows=lines.map(l=>l.split(",").map(v=>v.trim()));
      allData.push(rows);
      filesRead++;
      if(filesRead===files.length) mergeAllData(allData);
    };
    reader.readAsText(file);
  });
});

function mergeAllData(datasetList){
  const allHeaders=new Set();
  datasetList.forEach(rows=>{
    rows[0].forEach(h=>{
      if(!BLOCKED_COLUMNS.includes(h)) allHeaders.add(h);
    });
  });
  headers=[...allHeaders];

  const mergedRows=[];
  datasetList.forEach(rows=>{
    const fileHeaders=rows[0];
    const idxMap=fileHeaders.map(h=>headers.indexOf(h));
    for(let i=1;i<rows.length;i++){
      const row=new Array(headers.length).fill("");
      rows[i].forEach((cell,oldIndex)=>{
        const newIndex=idxMap[oldIndex];
        if(newIndex>=0) row[newIndex]=cell;
      });
      mergedRows.push(row);
    }
  });
  originalRows=[headers,...mergedRows];
  createColumnSelector(headers);
  renderTable(originalRows);
}

function createColumnSelector(headerList){
  const box=document.getElementById("columnSelector");
  box.innerHTML="";
  headerList.forEach((h,i)=>{
    let displayName=h;
    if(h.toLowerCase()==="acude") displayName="Pileta";
    else if(h.toLowerCase()==="numero_racao") displayName="Numero de ración";
    else if(h.toLowerCase()==="peso_esp_racao") displayName="Densidad (Gr/Lts)";
    else if(h.toLowerCase()==="racao_decarregad") displayName="Peso descargado";
    else if(h.toLowerCase()==="peso") displayName="Peso esperado";

    const label=document.createElement("label");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.value=i;
    cb.checked=true;
    label.appendChild(cb);
    label.append(" "+displayName);
    box.appendChild(label);
  });
}

document.getElementById("applyFilter").addEventListener("click",applyFilters);

function applyFilters(){
  if(originalRows.length===0) return;
  currentPage=1;
  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  const sumMode=document.getElementById("sumMode").checked;
  const pileta=document.getElementById("piletaSelector").value;

  const headerIndexDate=headers.findIndex(h=>h.toLowerCase().includes("date")||h.toLowerCase().includes("fecha"));
  const headerIndexPileta=headers.findIndex(h=>h.toLowerCase().includes("acude")||h.toLowerCase().includes("pileta"));

  filteredData=originalRows.slice(1).filter(r=>{
    if(headerIndexDate>=0){
      const d=r[headerIndexDate];
      if(!d) return false;
      const rowDate=new Date(d);
      if(start && rowDate<new Date(start)) return false;
      if(end && rowDate>new Date(end)) return false;
    }
    if(pileta && headerIndexPileta>=0){
      if(r[headerIndexPileta]!==pileta) return false;
    }
    return true;
  });

  updatePagination();
  document.getElementById("exportExcel").style.display="inline-block";
  renderPage(sumMode, pileta);
}

function updatePagination(){
  const rowsPerPage=parseInt(document.getElementById("rowsPerPage").value);
  totalPages=Math.ceil(filteredData.length/rowsPerPage);
}

function renderPage(sumMode=false, piletaFilter=""){
  const rowsPerPage=parseInt(document.getElementById("rowsPerPage").value);
  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const pageData=filteredData.slice(start,end);
  const selectedCols=[...document.querySelectorAll("#columnSelector input:checked")].map(cb=>parseInt(cb.value));

  const formatNumber = n => !isNaN(n) ? parseFloat(n).toLocaleString("es-ES",{minimumFractionDigits:2, maximumFractionDigits:2}) : n;

  if(sumMode){
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    let outputRows=[["Pileta","Peso esperado","Peso descargado"]];
    if(piletaFilter){
      let totalPeso=0, totalDesc=0;
      filteredData.forEach(r=>{
        totalPeso+=parseFloat(r[idxPeso]||0);
        totalDesc+=parseFloat(r[idxDesc]||0);
      });
      outputRows.push([piletaFilter, formatNumber(totalPeso), formatNumber(totalDesc)]);
    } else {
      const group={};
      filteredData.forEach(r=>{
        const p=r[idxPileta];
        if(!group[p]) group[p]={peso:0,desc:0};
        group[p].peso+=parseFloat(r[idxPeso]||0);
        group[p].desc+=parseFloat(r[idxDesc]||0);
      });
      Object.keys(group).sort().forEach(p=>{
        outputRows.push([p, formatNumber(group[p].peso), formatNumber(group[p].desc)]);
      });
    }
    renderTable(outputRows);
    return;
  }

  const tableRows=[[...selectedCols.map(i=>{
    let h=headers[i];
    if(h.toLowerCase()==="acude") return "Pileta";
    else if(h.toLowerCase()==="numero_racao") return "Numero de ración";
    else if(h.toLowerCase()==="peso_esp_racao") return "Densidad (Gr/Lts)";
    else if(h.toLowerCase()==="racao_decarregad") return "Peso descargado";
    else if(h.toLowerCase()==="peso") return "Peso esperado";
    else return h;
  })],
  ...pageData.map(r=>selectedCols.map(i=>formatNumber(r[i])))];

  renderTable(tableRows);
  document.getElementById("pageInfo").textContent=`Página ${currentPage} de ${totalPages}`;
  document.getElementById("prevPage").disabled=currentPage<=1;
  document.getElementById("nextPage").disabled=currentPage>=totalPages;
}

document.getElementById("prevPage").addEventListener("click",()=>{if(currentPage>1){currentPage--; renderPage(document.getElementById("sumMode").checked, document.getElementById("piletaSelector").value);}});
document.getElementById("nextPage").addEventListener("click",()=>{if(currentPage<totalPages){currentPage++; renderPage(document.getElementById("sumMode").checked, document.getElementById("piletaSelector").value);}});

document.getElementById("exportExcel").addEventListener("click",()=>{
  const sumMode=document.getElementById("sumMode").checked;
  const pileta=document.getElementById("piletaSelector").value;
  const formatNumber = n => !isNaN(n) ? parseFloat(n) : n;

  let ws_data = [];
  if(sumMode){
    const idxPeso=headers.findIndex(h=>h.toLowerCase()==="peso");
    const idxDesc=headers.findIndex(h=>h.toLowerCase()==="racao_decarregad");
    const idxPileta=headers.findIndex(h=>h.toLowerCase().includes("acude"));
    if(pileta){
      let totalPeso=0, totalDesc=0;
      filteredData.forEach(r=>{
        totalPeso+=parseFloat(r[idxPeso]||0);
        totalDesc+=parseFloat(r[idxDesc]||0);
      });
      ws_data=[["Pileta","Peso esperado","Peso descargado"], [pileta,totalPeso,totalDesc]];
    } else {
      const group={};
      filteredData.forEach(r=>{
        const p=r[idxPileta];
        if(!group[p]) group[p]={peso:0,desc:0};
        group[p].peso+=parseFloat(r[idxPeso]||0);
        group[p].desc+=parseFloat(r[idxDesc]||0);
      });
      ws_data=[["Pileta","Peso esperado","Peso descargado"]];
      Object.keys(group).sort().forEach(p=>{
        ws_data.push([p, group[p].peso, group[p].desc]);
      });
    }
  } else {
    const selectedCols=[...document.querySelectorAll("#columnSelector input:checked")].map(cb=>parseInt(cb.value));
    ws_data.push(selectedCols.map(i=>{
      let h=headers[i];
      if(h.toLowerCase()==="acude") return "Pileta";
      else if(h.toLowerCase()==="numero_racao") return "Numero de racion";
      else if(h.toLowerCase()==="peso_esp_racao") return "Densidad (Gr/Lts)";
      else if(h.toLowerCase()==="racao_decarregad") return "Peso descargado";
      else if(h.toLowerCase()==="peso") return "Peso esperado";
      else return h;
    }));
    filteredData.forEach(r=>{
      ws_data.push(selectedCols.map(i=>formatNumber(r[i])));
    });
  }

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Tabla");
  XLSX.writeFile(wb,"tabla.xlsx");
});

function renderTable(rows){
  const table=document.getElementById("output");
  table.innerHTML="";
  rows.forEach((row,i)=>{
    const tr=document.createElement("tr");
    row.forEach(cell=>{
      const tag=i===0?"th":"td";
      const td=document.createElement(tag);
      td.textContent=cell;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}
</script>
</body>
</html>
